# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## CRITICAL: Git Commit and PR Guidelines

**NEVER include any reference to Claude, AI, or automated generation in:**
- Git commit messages
- Pull request titles or descriptions
- Code comments

All commits and PRs must:
- Look completely professional and human-written
- Use conventional commit format without emojis
- Be indistinguishable from commits made by human developers
- NOT include "Generated by", "Co-Authored-By: Claude", or any AI attribution

## Project Overview

Event Manager (`github.com/rbaliyan/event`) is a production-grade event pub-sub library for Go with support for distributed event handling, metrics, tracing, and configurable transports.

## Build Commands

```bash
go test ./...          # Run all tests
go test -run TestName  # Run a specific test
go build ./...         # Build all packages
go mod tidy            # Clean up dependencies
```

## Preferred Architecture Patterns

### Constructor Pattern

Use the `New(*Config, ...Option)`, `Start(ctx) error`, `Close(ctx) error` pattern:

```go
// New creates instance without errors, only validates/populates config
func New(cfg *Config, opts ...Option) *Client

// Start initializes connections/resources (can return error)
// Use Connect() for client-like systems, Start() for server-like systems
func (c *Client) Start(ctx context.Context) error

// Close gracefully shuts down
func (c *Client) Close(ctx context.Context) error
```

### Options Pattern

Options should work with an unexported struct:

```go
// Exported option type
type Option func(*options)

// Unexported options struct
type options struct {
    bufferSize uint
    timeout    time.Duration
    // ...
}

// Constructor applies options then finalizes dependent fields
func New(opts ...Option) *Client {
    o := &options{
        // defaults
        bufferSize: 0,
        async:      false,
    }
    for _, opt := range opts {
        opt(o)
    }
    // Finalize dependent fields
    if o.async && o.bufferSize == 0 {
        o.bufferSize = DefaultBufferSize
    }
    // Copy to unexported client struct
    return &client{
        bufferSize: o.bufferSize,
        // ...
    }
}
```

### Key Principles

- Unexported config/options structs - only expose Option functions
- `New()` never returns error - just creates instance
- `Start()/Connect()` returns error - does actual initialization
- Dependent field resolution happens after all options applied, before copying to client

## Architecture

### Core Components

**Event (event.go)** - Central pub-sub implementation with `Publish()` and `Subscribe()` methods. Uses atomic operations for lock-free status management.

**Registry (registry.go)** - Scopes events to a namespace with lifecycle management. Thread-safe event storage with RWMutex. Provides both instance-based and global default registry.

**Transport (transport.go)** - Pluggable transport layer with two implementations:
- `channelMuxTransport`: Fan-out pattern - single input broadcasts to multiple subscriber channels (default)
- `singleChannelTransport`: All subscribers receive from one shared channel

**Context (context.go)** - Event metadata propagation through context, storing Event ID, Subscription ID, Source Registry ID, Metadata, Logger, and Registry.

**Metrics (metric.go)** - Prometheus integration tracking published/subscribed/processed totals and current counts. Lazy initialization with dummy implementation for zero-overhead when disabled.

### V2 Design

Transport owns delivery semantics:
```
Event (routing + middleware)
  └── Transport (delivery semantics)
        ├── Async goroutine spawning
        ├── Error handling via callback
        └── Graceful shutdown
```

### Middleware Chain Execution Order

When a handler is subscribed, it's wrapped in this chain (innermost to outermost):
```
Recovery (panic handling)
  → Tracing (OpenTelemetry spans)
    → Metrics (Prometheus counters)
      → Timeout (context deadline)
```

### Key Design Patterns

- **Functional Options Pattern**: Configuration via `Option` functions
- **Interface-Based Extensibility**: Transport and Metrics are interfaces for custom implementations
- **Atomic Status Management**: `int32` status flags with CompareAndSwap for lock-free state checks
- **Graceful Shutdown**: Registry shutdown broadcasts to all events via shutdown channel
- **Fire-and-Forget**: `Publish()` and `Subscribe()` return void - events are facts that happened

### Default Configuration

- Async: false (synchronous by default)
- Buffer size: 0 (blocking) when sync, 100 when async
- Worker pool size: 100 (when async enabled)
- Subscriber timeout: 0 (no timeout)
