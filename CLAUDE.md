# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## CRITICAL: Git Commit and PR Guidelines

**NEVER include any reference to Claude, AI, or automated generation in:**
- Git commit messages
- Pull request titles or descriptions
- Code comments

All commits and PRs must:
- Look completely professional and human-written
- Use conventional commit format without emojis
- Be indistinguishable from commits made by human developers
- NOT include "Generated by", "Co-Authored-By: Claude", or any AI attribution

## Project Overview

Event Manager (`github.com/rbaliyan/event`) is a production-grade event pub-sub library for Go with support for distributed event handling, metrics, tracing, and configurable transports.

## Build Commands

```bash
go test ./...          # Run all tests
go test -run TestName  # Run a specific test
go build ./...         # Build all packages
go mod tidy            # Clean up dependencies
```

## Preferred Architecture Patterns

### Constructor Pattern

Use the `New(name, ...Option) (*T, error)`, `Close(ctx) error` pattern:

```go
// NewBus creates a bus and returns error if transport missing or duplicate name
func NewBus(name string, opts ...BusOption) (*Bus, error)

// New creates an unbound event (must be registered with a bus)
func New[T any](name string, opts ...EventOption) Event[T]

// Register binds event to bus (returns error if type mismatch or bus closed)
func Register[T any](ctx context.Context, bus *Bus, event Event[T]) (Event[T], error)

// Close gracefully shuts down
func (b *Bus) Close(ctx context.Context) error
```

### Options Pattern

Options should work with an unexported struct:

```go
// Exported option type
type Option func(*options)

// Unexported options struct
type options struct {
    bufferSize uint
    timeout    time.Duration
    // ...
}

// Constructor applies options then finalizes dependent fields
func New(opts ...Option) *Client {
    o := &options{
        // defaults
        bufferSize: 0,
        async:      false,
    }
    for _, opt := range opts {
        opt(o)
    }
    // Finalize dependent fields
    if o.async && o.bufferSize == 0 {
        o.bufferSize = DefaultBufferSize
    }
    // Copy to unexported client struct
    return &client{
        bufferSize: o.bufferSize,
        // ...
    }
}
```

### Key Principles

- Unexported config/options structs - only expose Option functions
- `NewBus()` returns error - validates transport is provided and name is unique
- `New[T]()` returns unbound event - must be registered with `Register()`
- `Register()` returns error - does actual binding to bus and transport
- Dependent field resolution happens after all options applied, before copying to client

## Architecture

### Core Components

**Bus (bus.go)** - Central event bus that manages events and their lifecycle. Owns transport, tracing, metrics, and recovery settings. Provides global bus registry with full name support (`busname://eventname`).

**Event (event.go)** - Generic typed pub-sub implementation with `Publish()` and `Subscribe()` methods. Uses atomic operations for lock-free status management. Returns `ErrEventNotBound` if not registered.

**Transport (transport/)** - Pluggable transport layer with multiple implementations:
- `channel`: In-memory channel-based transport
- `redis`: Redis Streams transport with consumer groups
- `nats`: NATS Core and JetStream transports
- `kafka`: Apache Kafka transport with DLT support

**Context (context.go)** - Event metadata propagation through context, storing Event ID, Subscription ID, Source Bus ID, Metadata, Logger, and Bus reference.

**Middleware (middleware.go)** - Built-in middleware for deduplication, circuit breaker, monitoring, and custom handlers. Applied via `WithMiddleware()` subscribe option.

**Monitor (monitor/)** - Event processing monitoring with mode-aware tracking:
- Broadcast mode: tracks per `(EventID, SubscriptionID)`
- WorkerPool mode: tracks per `EventID` only
- Stores: PostgreSQL, MongoDB, in-memory
- HTTP API: `monitor/http` - REST handler using protoJSON
- gRPC API: `monitor/grpc` - gRPC service implementation
- Shared protobuf definitions in `monitor/proto`

**Schema Registry (schema/)** - Publisher-defined event configuration with subscriber auto-sync:
- Publishers define event configuration (timeouts, retries, feature flags)
- Subscribers auto-load schema on `Register()`
- Schema flags control which middleware is applied
- Providers: PostgreSQL, MongoDB, Redis, in-memory

### V3 Design

Bus owns infrastructure, Event owns routing:
```
Bus (transport, tracing, metrics, recovery)
  └── Event (routing + type safety)
        └── Transport (delivery semantics)
              ├── Delivery modes (Broadcast/WorkerPool)
              ├── Message acknowledgment
              └── Graceful shutdown
```

### Middleware Chain Execution Order

When a handler is subscribed, it's wrapped in this chain (innermost to outermost):
```
Recovery (panic handling)
  → Timeout (context deadline)
    → Custom middleware (via WithMiddleware)
      → Idempotency (bus-level, controlled by schema if loaded)
        → Poison detection (bus-level, controlled by schema if loaded)
          → Monitor (bus-level, controlled by schema if loaded)
```

**Schema-Controlled Middleware:**
- When schema is loaded: middleware is only applied if `Enable*` flag is true AND store is configured
- When no schema: falls back to bus-level middleware (if stores are configured)

### Key Design Patterns

- **Functional Options Pattern**: Configuration via `Option` functions
- **Interface-Based Extensibility**: Transport is an interface for custom implementations
- **Atomic Status Management**: `int32` status flags with CompareAndSwap for lock-free state checks
- **Graceful Shutdown**: Bus shutdown broadcasts to all events via shutdown channel
- **Global Bus Registry**: Buses registered by name, events accessible via `busname://eventname`
- **Type-Safe Generics**: `Event[T]` ensures compile-time type safety

### Default Configuration

- Tracing: enabled (OpenTelemetry)
- Recovery: enabled (panic handling)
- Metrics: enabled (OpenTelemetry)
- Subscriber timeout: 0 (no timeout)
- Delivery mode: Broadcast (all subscribers receive)

### Monitor HTTP/gRPC API

Handler-only approach - no server management, middleware, or auth. Integrating systems mount handlers with their own servers:

**HTTP Handler (`monitor/http`):**
- Implements `http.Handler` interface
- Uses protoJSON for serialization
- REST endpoints under `/v1/monitor/entries`
- Query parameters for filtering
- DELETE defaults to 24h, requires `force=true` for newer entries

**gRPC Service (`monitor/grpc`):**
- `New(store)` creates service
- `Register(server *grpc.Server)` registers with gRPC server
- Uses shared protobuf definitions from `monitor/proto`

**Protobuf (`monitor/proto`):**
- `monitor.proto` - service and message definitions
- `convert.go` - type conversions between domain and protobuf types
- Generate with: `protoc --go_out=. --go-grpc_out=. monitor.proto`
